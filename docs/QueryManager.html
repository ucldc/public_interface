<!DOCTYPE html>

<html>
<head>
  <title>QueryManager.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="ComplexCarouselView.html">
                  ComplexCarouselView.js
                </a>
              
                
                <a class="source" href="ContactOwnerFormView.html">
                  ContactOwnerFormView.js
                </a>
              
                
                <a class="source" href="Controller.html">
                  Controller.js
                </a>
              
                
                <a class="source" href="ExhibitPageView.html">
                  ExhibitPageView.js
                </a>
              
                
                <a class="source" href="FacetFormView.html">
                  FacetFormView.js
                </a>
              
                
                <a class="source" href="GlobalSearchFormView.html">
                  GlobalSearchFormView.js
                </a>
              
                
                <a class="source" href="ItemView.html">
                  ItemView.js
                </a>
              
                
                <a class="source" href="QueryManager.html">
                  QueryManager.js
                </a>
              
                
                <a class="source" href="calisphere-home.html">
                  calisphere-home.js
                </a>
              
                
                <a class="source" href="calisphere.html">
                  calisphere.js
                </a>
              
                
                <a class="source" href="main.html">
                  main.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>QueryManager.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/*global Backbone */</span>
<span class="hljs-comment">/*global _ */</span>
<span class="hljs-comment">/*exported QueryManager */</span>
<span class="hljs-meta">
'use strict'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>The Query parameters are stored in three places: the DOM, Session Storage, 
and the JavaScript. Typically the DOM is most correct - having returned from 
the server. The JavaScript keeps track of things while waiting for a server
response. Session storage really only matters if pjax breaks. When the full
page comes back, the JavaScript can pick right back up with the current context
via session storage. </p>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>The Query Manager manages two distinct types of query data which are related
but distinct. There is the general query information: <code>q</code>, <code>rq</code> (refine query), <code>view_format</code>,
<code>sort</code>, <code>relevance</code>, <code>rows</code>, <code>start</code>, <code>type_of_work</code>, <code>decade</code>, <code>collection_data</code>,
<code>repository_data</code> and there is also the item-specific query information: <code>itemId</code>, 
<code>itemNumber</code> (where the item falls in the results set - used to calculate the 
‘start’ offset for the carousel), <code>referral</code>, and <code>referralName</code> </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> QueryManager = Backbone.Model.extend({
  
  <span class="hljs-attr">defaultValues</span>: {
    <span class="hljs-comment">/* q: '', */</span>
    rq: <span class="hljs-string">''</span>,
    <span class="hljs-attr">view_format</span>: <span class="hljs-string">'thumbnails'</span>,
    <span class="hljs-attr">sort</span>: <span class="hljs-string">'relevance'</span>, 
    <span class="hljs-attr">rows</span>: <span class="hljs-string">'24'</span>,
    <span class="hljs-attr">start</span>: <span class="hljs-number">0</span>
  },
  
  <span class="hljs-attr">getQueryFromDOM</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">formName</span>) </span>{
    <span class="hljs-keyword">var</span> formSelector = <span class="hljs-string">'[form='</span> + formName + <span class="hljs-string">']'</span>;

    <span class="hljs-keyword">if</span> ($(formSelector).length &gt; <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>$.extend({}) automatically removes undefined values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> queryObj = $.extend({}, {
        <span class="hljs-attr">q</span>: $(formSelector + <span class="hljs-string">'[name=q]'</span>).val(),
        <span class="hljs-attr">view_format</span>: $(formSelector + <span class="hljs-string">'[name=view_format]'</span>).val(),
        <span class="hljs-attr">sort</span>: $(formSelector + <span class="hljs-string">'[name=sort]'</span>).val(),
        <span class="hljs-attr">rows</span>: $(formSelector + <span class="hljs-string">'[name=rows]'</span>).val(),
        <span class="hljs-attr">start</span>: $(formSelector + <span class="hljs-string">'[name=start]'</span>).val(),
      });
      <span class="hljs-keyword">if</span> (queryObj.start) { queryObj.start = <span class="hljs-built_in">parseInt</span>(queryObj.start); }</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>:visible differentiates between actual filters and implied filters,
such as collection_data on a collection page (stored in an <input hidden class=js-facet> elem)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> filters;
      <span class="hljs-keyword">if</span> (formSelector === <span class="hljs-string">'js-facet'</span>) {
        filters = $(formSelector + <span class="hljs-string">'.js-facet:visible'</span>).serializeArray();
      } <span class="hljs-keyword">else</span> {
        filters = $(formSelector + <span class="hljs-string">'.js-facet'</span>).serializeArray();
      }
      <span class="hljs-keyword">if</span> (filters.length &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;filters.length; i++) {
          <span class="hljs-keyword">var</span> filter = filters[i];</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>if attributes has key of this filter type</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> (_.has(queryObj, filter.name)) {
            queryObj[filter.name].push(filter.value);
          } <span class="hljs-keyword">else</span> {
            queryObj[filter.name] = [filter.value];
          }
        }
      }
      <span class="hljs-keyword">var</span> refineArray = $(formSelector + <span class="hljs-string">'[name=rq]'</span>).serializeArray();
      <span class="hljs-keyword">if</span> (refineArray.length &gt; <span class="hljs-number">0</span>) {
        queryObj.rq = [];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j=<span class="hljs-number">0</span>; j&lt;refineArray.length; j++) {
          <span class="hljs-keyword">if</span> (refineArray[j].value !== <span class="hljs-string">''</span>) {
            queryObj.rq.push(refineArray[j].value);
          }
        }
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>this causes any previously defined facet values
to be wiped out. (see l-120 of this file)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      queryObj = _.defaults(queryObj, {<span class="hljs-attr">type_ss</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">facet_decade</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">repository_data</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">collection_data</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">rq</span>: <span class="hljs-string">''</span>});
      <span class="hljs-keyword">return</span> queryObj;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'[ERROR]: QueryManager attempting to retrieve query parameters from '</span> + formName + <span class="hljs-string">' form when no form is in DOM.'</span>);
      <span class="hljs-keyword">return</span> {};
    }
  },

  <span class="hljs-attr">getItemInfoFromDOM</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> ($(<span class="hljs-string">'[form=js-carouselForm]'</span>).length &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">var</span> carouselInfoObj = {
        <span class="hljs-attr">itemId</span>: $(<span class="hljs-string">'#js-objectViewport'</span>).data(<span class="hljs-string">'item_id'</span>) || $(<span class="hljs-string">'[form=js-carouselForm][name=itemId]'</span>).val() || <span class="hljs-string">''</span>,
        <span class="hljs-attr">referral</span>: $(<span class="hljs-string">'[form=js-carouselForm][name=referral]'</span>).val() || <span class="hljs-string">''</span>,
        <span class="hljs-attr">referralName</span>: $(<span class="hljs-string">'[form=js-carouselForm][name=referralName]'</span>).val() || <span class="hljs-string">''</span>,
      };

      carouselInfoObj.itemNumber =
        $(<span class="hljs-string">'.js-item-link[data-item_id="'</span> + carouselInfoObj.itemId + <span class="hljs-string">'"]'</span>).data(<span class="hljs-string">'item_number'</span>) ||
        $(<span class="hljs-string">'[form=js-carouselForm][name=itemNumber]'</span>).val() ||
        <span class="hljs-string">''</span>;

      <span class="hljs-keyword">if</span> (carouselInfoObj.referral === <span class="hljs-string">'collection'</span>) {
        carouselInfoObj.collection_data = <span class="hljs-built_in">parseInt</span>($(<span class="hljs-string">'[form=js-carouselForm][name=collection_url]'</span>).val());
      }
      <span class="hljs-keyword">if</span> (carouselInfoObj.referral === <span class="hljs-string">'institution'</span>) {
        carouselInfoObj.repository_data = <span class="hljs-built_in">parseInt</span>($(<span class="hljs-string">'[form=js-carouselForm][name=repository_url]'</span>).val());
      }
      <span class="hljs-keyword">if</span> (carouselInfoObj.referral === <span class="hljs-string">'campus'</span>) {
        carouselInfoObj.campus_slug = $(<span class="hljs-string">'[form=js-carouselForm][name=campus_slug]'</span>).val();
      }

      <span class="hljs-keyword">return</span> carouselInfoObj;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'[ERROR]: QueryManager attempting to retrieve item information from js-carouselForm when no such form is in DOM.'</span>);
      <span class="hljs-keyword">return</span> {};
    }
  },

  <span class="hljs-attr">unsetItemInfo</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">this</span>.unset(<span class="hljs-string">'itemId'</span>, {<span class="hljs-attr">silent</span>: <span class="hljs-literal">true</span>});
    <span class="hljs-keyword">this</span>.unset(<span class="hljs-string">'itemNumber'</span>, {<span class="hljs-attr">silent</span>: <span class="hljs-literal">true</span>});

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'referral'</span>) !== <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'referral'</span>) === <span class="hljs-string">'institution'</span>) {
        <span class="hljs-keyword">this</span>.unset(<span class="hljs-string">'repository_data'</span>, {<span class="hljs-attr">silent</span>: <span class="hljs-literal">true</span>});
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'referral'</span>) === <span class="hljs-string">'campus'</span>) {
        <span class="hljs-keyword">this</span>.unset(<span class="hljs-string">'campus_slug'</span>, {<span class="hljs-attr">silent</span>: <span class="hljs-literal">true</span>});
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.get(<span class="hljs-string">'referral'</span>) === <span class="hljs-string">'collection'</span>) {
        <span class="hljs-keyword">this</span>.unset(<span class="hljs-string">'collection_data'</span>, {<span class="hljs-attr">silent</span>: <span class="hljs-literal">true</span>});
      }
      <span class="hljs-keyword">this</span>.unset(<span class="hljs-string">'referral'</span>, {<span class="hljs-attr">silent</span>: <span class="hljs-literal">true</span>});
      <span class="hljs-keyword">this</span>.unset(<span class="hljs-string">'referralName'</span>, {<span class="hljs-attr">silent</span>: <span class="hljs-literal">true</span>});
    }
  },

  <span class="hljs-attr">initialize</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> attributes;
    <span class="hljs-keyword">if</span> (sessionStorage.length &gt; <span class="hljs-number">0</span>) {
      attributes = {
        <span class="hljs-attr">q</span>: sessionStorage.getItem(<span class="hljs-string">'q'</span>),
        <span class="hljs-attr">rq</span>: <span class="hljs-built_in">JSON</span>.parse(sessionStorage.getItem(<span class="hljs-string">'rq'</span>)),
        <span class="hljs-attr">view_format</span>: sessionStorage.getItem(<span class="hljs-string">'view_format'</span>),
        <span class="hljs-attr">sort</span>: sessionStorage.getItem(<span class="hljs-string">'sort'</span>),
        <span class="hljs-attr">start</span>: sessionStorage.getItem(<span class="hljs-string">'start'</span>),
        <span class="hljs-attr">type_ss</span>: <span class="hljs-built_in">JSON</span>.parse(sessionStorage.getItem(<span class="hljs-string">'type_ss'</span>)),
        <span class="hljs-attr">facet_decade</span>: <span class="hljs-built_in">JSON</span>.parse(sessionStorage.getItem(<span class="hljs-string">'facet_decade'</span>)),
        <span class="hljs-attr">repository_data</span>: <span class="hljs-built_in">JSON</span>.parse(sessionStorage.getItem(<span class="hljs-string">'repository_data'</span>)),
        <span class="hljs-attr">collection_data</span>: <span class="hljs-built_in">JSON</span>.parse(sessionStorage.getItem(<span class="hljs-string">'collection_data'</span>)),

        <span class="hljs-attr">campus_slug</span>: sessionStorage.getItem(<span class="hljs-string">'campus_slug'</span>),
        <span class="hljs-attr">itemNumber</span>: sessionStorage.getItem(<span class="hljs-string">'itemNumber'</span>),
        <span class="hljs-attr">itemId</span>: sessionStorage.getItem(<span class="hljs-string">'itemId'</span>),
        <span class="hljs-attr">referral</span>: sessionStorage.getItem(<span class="hljs-string">'referral'</span>),
        <span class="hljs-attr">referralName</span>: sessionStorage.getItem(<span class="hljs-string">'referralName'</span>)
      };
    } 
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ($(<span class="hljs-string">'[form=js-facet]'</span>).length) {
      attributes = <span class="hljs-keyword">this</span>.getQueryFromDOM(<span class="hljs-string">'js-facet'</span>);
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ($(<span class="hljs-string">'[form=js-carouselForm]'</span>).length) {
      attributes = <span class="hljs-keyword">this</span>.getQueryFromDOM(<span class="hljs-string">'js-carouselForm'</span>);
      attributes = _.extend(attributes, <span class="hljs-keyword">this</span>.getItemInfoFromDOM());
    }

    attributes = _.omit(attributes, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{
      <span class="hljs-keyword">return</span> _.isNull(value);
    });
    <span class="hljs-keyword">this</span>.set(attributes);
  },
  
  <span class="hljs-attr">setSessionStorage</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value, key</span>) </span>{
    <span class="hljs-keyword">if</span> (_.isArray(value)) {
      sessionStorage.setItem(key, <span class="hljs-built_in">JSON</span>.stringify(value));
    } <span class="hljs-keyword">else</span> {
      sessionStorage.setItem(key, value);
    }
  },
  
  <span class="hljs-attr">unsetSessionStorage</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value, key</span>) </span>{
    <span class="hljs-keyword">if</span> (key === <span class="hljs-literal">undefined</span>) {
      key = value;
    }
    sessionStorage.removeItem(key);
  },
    
  <span class="hljs-attr">set</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">key, value, options</span>) </span>{
    <span class="hljs-keyword">if</span> (key === <span class="hljs-literal">null</span>) { <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>; }
    
    <span class="hljs-keyword">var</span> attrs;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> key === <span class="hljs-string">'object'</span>) {
      attrs = key;
      options = value;
    } <span class="hljs-keyword">else</span> {
      (attrs = {})[key] = value;
    }
    
    options = options || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>if we’re setting an attribute to default, remove it from the list</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each(attrs, (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">that</span>) </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value, key, list</span>) </span>{
        <span class="hljs-keyword">if</span> (value !== <span class="hljs-literal">undefined</span>) {
          <span class="hljs-keyword">if</span> ((that.defaultValues[key] !== <span class="hljs-literal">undefined</span> &amp;&amp; that.defaultValues[key] === value) || (value.length === <span class="hljs-number">0</span> &amp;&amp; key !== <span class="hljs-string">'q'</span>)) {
            <span class="hljs-keyword">delete</span> list[key];
            that.unsetSessionStorage(key);
            <span class="hljs-keyword">if</span> (_.isEmpty(list)) {
              that.unset(key);
            } <span class="hljs-keyword">else</span> {
              that.unset(key, {<span class="hljs-attr">silent</span>: <span class="hljs-literal">true</span>});
            }
          }          
        }
      };
    }(<span class="hljs-keyword">this</span>)));
        
    Backbone.Model.prototype.set.apply(<span class="hljs-keyword">this</span>, [attrs, options]);
    
    <span class="hljs-keyword">if</span> (!options.unset) {
      _.each(attrs, <span class="hljs-keyword">this</span>.setSessionStorage);
    } <span class="hljs-keyword">else</span> {
      _.each(attrs, <span class="hljs-keyword">this</span>.unsetSessionStorage);
    }
  },
    
  <span class="hljs-attr">clear</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    Backbone.Model.prototype.clear.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
    sessionStorage.clear();
  }, 
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
